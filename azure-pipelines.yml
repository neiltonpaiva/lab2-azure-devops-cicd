trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  awsRegion: 'us-east-1'
  ecrRepository: 'lab2-ecs-nginx'       # AJUSTAR SE NOME DO REPO FOR OUTRO
  ecsCluster: 'lab2-ecs-cluster'        # AJUSTAR PRO NOME REAL DO CLUSTER
  ecsService: 'lab2-ecs-service'        # AJUSTAR PRO NOME REAL DO SERVICE

stages:
  - stage: Build
    displayName: Build & Push
    jobs:
      - job: BuildAndPush
        displayName: Build and Push to ECR
        steps:
          - checkout: self

          - script: |
              TAG=$(git rev-parse --short HEAD)
              echo "##vso[task.setvariable variable=imageTag]$TAG"
              echo "Usando TAG: $TAG"
            displayName: "Definir TAG (SHA)"

          - task: AWSCLI@1
            displayName: "Login no ECR e Push"
            inputs:
              awsCredentials: 'lab2-azure-devops-cicd-connection'   # NOME EXATO DA SERVICE CONNECTION
              regionName: '$(awsRegion)'
              awsCommand: |
                set -e

                ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
                REGION="$(awsRegion)"
                REPO="$(ecrRepository)"
                TAG="$(imageTag)"

                ECR_URI="${ACCOUNT_ID}.dkr.ecr.${REGION}.amazonaws.com/${REPO}"

                echo "ECR_URI: $ECR_URI"
                echo "TAG: $TAG"

                aws ecr get-login-password --region "$REGION" | \
                  docker login --username AWS --password-stdin "$ECR_URI"

                docker build -t "$ECR_URI:$TAG" -t "$ECR_URI:latest" .
                docker push "$ECR_URI:$TAG"
                docker push "$ECR_URI:latest"

  - stage: Deploy
    displayName: Deploy ECS
    dependsOn: Build
    jobs:
      - job: DeployToEcs
        displayName: Deploy to ECS
        steps:
          - checkout: self

          - script: |
              TAG=$(git rev-parse --short HEAD)
              echo "##vso[task.setvariable variable=imageTag]$TAG"
              echo "Usando TAG (Deploy): $TAG"
            displayName: "Garantir mesma TAG"

          - task: AWSCLI@1
            displayName: "Renderizar Task Definition"
            inputs:
              awsCredentials: 'lab2-azure-devops-cicd-connection'
              regionName: '$(awsRegion)'
              awsCommand: |
                set -e

                ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
                REGION="$(awsRegion)"
                REPO="$(ecrRepository)"
                TAG="$(imageTag)"

                ECR_URI="${ACCOUNT_ID}.dkr.ecr.${REGION}.amazonaws.com/${REPO}"
                IMAGE="${ECR_URI}:${TAG}"

                echo "Imagem na TD: $IMAGE"

                sed "s|REPLACE_IMAGE|$IMAGE|g" ecs-task-def.json > rendered-task-def.json

                echo "Task definition resultante:"
                cat rendered-task-def.json

          - task: AWSCLI@1
            displayName: "Registrar nova Task Definition"
            inputs:
              awsCredentials: 'lab2-azure-devops-cicd-connection'
              regionName: '$(awsRegion)'
              awsCommand: |
                set -e

                ARN=$(aws ecs register-task-definition \
                  --cli-input-json file://rendered-task-def.json \
                  --query "taskDefinition.taskDefinitionArn" \
                  --output text)

                echo "Nova Task Definition ARN: $ARN"
                echo "##vso[task.setvariable variable=taskDefArn]$ARN"

          - task: AWSCLI@1
            displayName: "Atualizar Service ECS"
            inputs:
              awsCredentials: 'lab2-azure-devops-cicd-connection'
              regionName: '$(awsRegion)'
              awsCommand: |
                set -e

                CLUSTER="$(ecsCluster)"
                SERVICE="$(ecsService)"
                TASK_DEF_ARN="$(taskDefArn)"

                echo "Atualizando service $SERVICE no cluster $CLUSTER para TD:"
                echo "  $TASK_DEF_ARN"

                aws ecs update-service \
                  --cluster "$CLUSTER" \
                  --service "$SERVICE" \
                  --task-definition "$TASK_DEF_ARN" \
                  --force-new-deployment

                echo "Aguardando serviço estabilizar..."
                aws ecs wait services-stable \
                  --cluster "$CLUSTER" \
                  --services "$SERVICE"

                echo "Deploy ECS concluído com sucesso."
